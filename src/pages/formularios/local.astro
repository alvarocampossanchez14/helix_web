---
import Layout from '../../layouts/Layout.astro';
import MultiStepForm from '../../components/MultiStepForm.astro';
import "../../styles/global.css";

const SESSION_COOKIE_NAME = 'dsc_access_token';
const sessionCookie = Astro.cookies.get(SESSION_COOKIE_NAME);
let user = null;

if (sessionCookie) {
  try {
    const origin = Astro.url.origin;
    const userDataResponse = await fetch(`${origin}/api/user/data`, {
      headers: Astro.request.headers
    });
    
    if (userDataResponse.ok) {
      user = await userDataResponse.json();
    } else {
      Astro.cookies.delete(SESSION_COOKIE_NAME);
    }
  } catch (e) {
    console.error("Error en la validaci칩n de la sesi칩n:", e);
    Astro.cookies.delete(SESSION_COOKIE_NAME);
  }
}

// Estructura del formulario
const requirements = `
  <p class="mb-4">
    游늯 FORMULARIO COMPLETO DE POSTULACI칍N A LOCAL
  </p>
  <p class="mb-4">
    Se valorar치n especialmente aquellos proyectos y organizaciones que fomenten el rol de calidad dentro del servidor, con propuestas bien desarrolladas y enfocadas en la interacci칩n con otros jugadores.
  </p>
  <p class="mb-4">
    Rogamos que las postulaciones presentadas est칠n bien estructuradas, detalladas y cuidadas en su redacci칩n, guardando la estructura del formato.
  </p>
`;

const formSteps = [
  {
    title: 'Datos Generales',
    fields: [
      { name: 'nombre', label: 'Nombre de Discord', value: user?.username, readonly: true, isBaseData: true },
      { name: 'discord_id', label: 'Discord ID', value: user?.id, readonly: true, isBaseData: true },
      { name: 'nombre_personaje', label: 'Nombre del personaje (IC)', placeholder: 'Nombre completo de tu personaje', required: true },
      { name: 'edad', label: 'Edad (IC / OOC)', placeholder: 'Edad del personaje / Edad real', required: true },
      { name: 'pais_zona_horaria', label: 'Pa칤s y zona horaria (OOC)', placeholder: 'Esto ayuda a coordinar mejor horarios de apertura', required: true }
    ]
  },
  {
    title: 'Informaci칩n del Negocio',
    fields: [
      { name: 'descripcion_negocio', label: 'Descripci칩n detallada del negocio', type: 'textarea', placeholder: '쯈u칠 tipo de servicios ofrecer치s? 쮺칩mo se va a diferenciar de otros negocios?', required: true }
    ]
  },
  {
    title: 'Funcionamiento y Organizaci칩n',
    fields: [
      { name: 'equipo_trabajo', label: '쯊rabajar치s solo/a o con un equipo?', type: 'textarea', placeholder: 'Explica si ya tienes un equipo armado, cu치ntos miembros son, qu칠 roles ocupar치n...', required: true },
      { name: 'contrataciones_ic', label: '쮸brir치s contrataciones IC?', type: 'textarea', placeholder: 'S칤 / No. 쯈u칠 tipo de perfiles buscar치s?', required: true },
      { name: 'rangos_internos', label: '쯊endr치s rangos o estructura interna?', type: 'textarea', placeholder: 'Explica c칩mo se organizar치n dentro del local', required: true },
      { name: 'horario_apertura', label: 'Horario aproximado de apertura (IC)', placeholder: 'D칤as de la semana y franjas horarias', required: true }
    ]
  },
  {
    title: 'Propuestas de Roleo',
    fields: [
      { name: 'ideas_roleo', label: 'Ideas de tramas o eventos', type: 'textarea', placeholder: 'Detalla 2 o 3 ideas que tengas pensadas para generar rol', required: true },
      { name: 'colaboraciones', label: '쯇iensas colaborar con otros negocios o facciones?', type: 'textarea', placeholder: '쮺on qui칠n te gustar칤a colaborar? 쮺칩mo ves esas posibles conexiones?', required: true },
      { name: 'aporte_servidor', label: '쯈u칠 aportar치 tu negocio al servidor?', type: 'textarea', placeholder: 'Habla de tu visi칩n, tu compromiso y c칩mo planeas mantener activa la propuesta', required: true }
    ]
  }
];
---

<Layout title="Postulaci칩n Local">
  <div class="container mx-auto p-8 text-gray-200 min-h-screen bg-black">
    <MultiStepForm
      title="Postulaci칩n Local"
      requirements={requirements}
      steps={formSteps}
      user={user}
      formType="bussiness"
    />
  </div>
</Layout>
